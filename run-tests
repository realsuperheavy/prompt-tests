#!/bin/bash
export TTY
# shopt -s nullglob # use for 'for' loops but not for 'ls', 'grep'

# git-repo-for-each-branch-do "https://github.com/semiosis/prompts/" "$MYGIT/semiosis/prompt-tests/run-tests"| v

test -d "prompts" || exit 1

cd prompts

for fp in *; do
    if ! { test -f "$fp" && pl "$fp" | grep -q -P '\.prompt$'; }; then
        continue
    fi

    echo "$fp" | udl | hls purple
    delim="Â¬"
    IFS="$delim" read -r -d$'\1' version title < <(
        cat "$fp" | yq -r '[."prompt-version",.title] | join("'$delim'")')

    : "${version:="0"}"

    eval "set -- $(cat "$fp" | yq ".examples // empty | .[]" | s join ' ')"

    slug="$(printf -- "%s\n" "$title" | tr '\n' ' ' | sed 's/ $//' | slugify)"

    testfp="$MYGIT/semiosis/prompt-tests/results/${slug}-v${version}.txt"
    if ! test -f "$testfp"; then
        openai-complete "$fp" "$@" > "$testfp"
    fi
done